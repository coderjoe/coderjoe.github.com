
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How I Won the OpenStack Birthday Contest - coderjoe.net</title>
  <meta name="author" content="Joe "coderjoe" Bauser">

  
  <meta name="description" content="Last week I stumbled across the &#8220;AppFog OpenStack Birthday Contest&#8221; via Twitter. I&#8217;d been quietly following AppFog&#8217;s progress &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://coderjoe.net/archive/2012/07/26/openstack-contest-post-mortem/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="coderjoe.net" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-526253-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">coderjoe.net</a></h1>
  
    <h2>Me, myself, and my code</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:coderjoe.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How I Won the OpenStack Birthday Contest</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-26T19:01:00-04:00" pubdate data-updated="true">Jul 26<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Last week I stumbled across the <a href="http://openstack.appfog.com">&#8220;AppFog OpenStack Birthday Contest&#8221;</a> via Twitter.</p>

<p>I&#8217;d been quietly following AppFog&#8217;s progress since I received a PHPFog beta invite a year or two ago. At the time I hadn&#8217;t had a reason to give their service a try since I wasn&#8217;t a PHP guy. However, spurred by the allure of a coding contest and the large number of platforms AppFog supports, I finally had a reason to poke around!</p>

<p>Anticipating that I&#8217;d be up against stiff competition I chose to place some additional requirements on my contest submission. As the AppFog Blog <a href="http://blog.appfog.com/other-amazing-entries-from-the-openstack-contest/">recently showed</a> I wasn&#8217;t wrong about the competition. My hope was that the extra work I put into the submission would grant me at least an honorable mention.</p>

<p>What I didn&#8217;t expect was that I&#8217;d end up <a href="http://blog.appfog.com/congratulations-to-joe-bauser-on-winning-the-openstack-obfuscated-code-competition/">winning the competition</a>!</p>

<p>I am honored that my code was chosen as the winning submission. As a small show of thanks, I&#8217;ve decided to detail my experiences with the AppFog beta as well as annotate the de-obfuscation of my code step-by-step.</p>

<!--more-->


<h2>An AppFog First Impression</h2>

<p>My first concern was getting an AppFog instance configured on which to develop. While I do have a little bit of experience dealing with shared hosting and VPS services, I have only minimal exposure to PaaS providers such as <a href="http://www.appfog.com">AppFog</a>. At first I was worried about the work required to configure an application, but AppFog&#8217;s simple interface had me finished with the process before I knew I had started!</p>

<p>After cloning an <a href="https://github.com/appfog/af-ruby-sinatra">example project</a> published by AppFog on github, installing the <a href="http://rubygems.org/gems/af">AppFog gem</a>, and running a deploy I was done! Zero to functioning application in almost exactly 2 minutes!</p>

<p>Thanks to the simple in AppFog deployment process I was able to concentrate entirely on my code, and not my hosting.</p>

<h2>Some Speed Bumps</h2>

<p>Unfortunately I can&#8217;t say that my experience with AppFog was completely problem free. During development I ran into occasional trouble with deployment. Applications that ran perfectly fine locally started timing out regularly during staging. When they staged they would fail to start. A few of these problems were of my own making and were easily resolved by checking the support area of the AppFog site.</p>

<p>For the more difficult problems, the AppFog support team met or exceeded the customer service I&#8217;d grown accustom to from both <a href="http://dreamhost.com">Dreamhost</a> and <a href="http://linode.com">Linode</a>. With the help of the AppFog support team I was able to fix my deployment problems and submit my solution. I was especially impressed by their responsiveness given I hadn&#8217;t paid them a cent!</p>

<p>Enough about problems&#8230; on to the code!</p>

<h2>Creating a Contest Submission</h2>

<p>Now, I love obfuscation just as much as the next guy, but I wanted my submission to be slightly more than just a block of funny looking text. I wanted my submission to have a few extra (admittedly simple) levels of trickery involved. In order to satisfy this urge I added the following extra personal submission requirements:</p>

<ol>
<li>The code must be pretty.</li>
<li>The code must be obfuscated in at least two separate ways.</li>
<li>The final &#8220;Happy Birthday OpenStack&#8221; text must exist in some way outside of the source code itself.</li>
</ol>


<p>In order to understand how I achieved these objectives lets walk backwards through the obfuscation steps to reveal the original source code.</p>

<p><strong>Note:</strong> What follows is a step-by-step analysis of the code itself, performed through the lens of someone de-obfuscating my submission. The contents of this analysis are targeted at someone with minimal Ruby experience. If you feel you understand Ruby you may get more enjoyment out of attempting the de-obfuscation yourself!</p>

<h2>Understanding the Obfuscation</h2>

<p>None of the methods of code obfuscation I used are terribly complex. The <a href="https://github.com/coderjoe/happy_birthday_openstack/blob/a422a74da8b565c897079bc4b0af49490a4bdeca/app.rb">full submission</a> is plenty pretty with ASCII art declaring my affection for the people running the contest.</p>

<p>The ASCII art itself was created with the help of an open source tool called <a href="http://csl.sublevel3.org/jp2a/">jp2a</a> by <a href="http://csl.sublevel3.org/">Christian Stigen Larsen</a>. The generated ASCII was then used to format the resulting block of obfuscated code. This method allowed me to obfuscate the code first, then tweak the ASCII art as I saw fit.</p>

<p>Despite how complicated it may look my submission boils down to the following four lines of code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">c</span> <span class="o">=</span> <span class="sx">%w(A bunch of characters with lots of whitespace)</span><span class="o">.</span><span class="n">join</span>
</span><span class='line'><span class="n">z</span> <span class="o">=</span> <span class="s1">&#39;Znqr_ol_Wbr_&quot;pbqrewbr&quot;_Onhfre&#39;</span>
</span><span class='line'><span class="no">XYZZY</span> <span class="o">=</span> <span class="bp">__FILE__</span>
</span><span class='line'><span class="nb">send</span><span class="p">(</span><span class="sx">%w(ale lava)</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">join</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span><span class="o">.</span><span class="n">join</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">to_sym</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/0x/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">to_i</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">chr</span><span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Despite separating the lines of code it is still plenty hard to understand what it is doing. Lets take it line by line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">c</span> <span class="o">=</span> <span class="sx">%w(A bunch of characters with whitespace)</span><span class="o">.</span><span class="n">join</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above uses Ruby&#8217;s quoted array syntax to turn a bunch of whitespace separated strings into an array of values.</p>

<figure class='code'><figcaption><span>Quoted Array Example - quoted_example.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="c1">#The whitespace separated tokens become strings in the array</span>
</span><span class='line'><span class="sx">%w(one two three)</span> <span class="c1"># =&gt; [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#Both using an uppercase W will function the same</span>
</span><span class='line'><span class="sx">%W(one two three)</span> <span class="c1"># =&gt; [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#If your tokens need to include parentheses the quoted character can be almost any</span>
</span><span class='line'><span class="c1">#special character. If the special character is one of {, [, (, or &lt; then the end</span>
</span><span class='line'><span class="c1">#character will be the matching closing delimiter. For other characters it is just</span>
</span><span class='line'><span class="c1">#the same delimiter</span>
</span><span class='line'><span class="sx">%w[one two three]</span> <span class="c1"># =&gt; [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]</span>
</span><span class='line'><span class="sx">%w!one two three!</span> <span class="c1"># =&gt; [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]</span>
</span><span class='line'><span class="sx">%w|one two three|</span> <span class="c1"># =&gt; [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This means that the code takes the humongous block of gibberish and turns it into a huge array of tokens. The <code>join</code> method is immediately called on the response, meaning the variable <code>c</code> contains a large string of characters.</p>

<p>The second line is a red-herring rot13 representation of the phrase <code>Made_by_Joe_"coderjoe"_Bauser"</code> which can be safely ignored.</p>

<p>The third line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">XYZZY</span> <span class="o">=</span> <span class="bp">__FILE__</span>
</span></code></pre></td></tr></table></div></figure>


<p>Does nothing more than store the value of <code>__FILE__</code> (which represents the name of the currently running file) into a constant variable named <code>XYZZY</code>.</p>

<p>The last line is the meat and potatoes of this file. It has the job of interpreting the huge block of text! If we create some temporary variables we can see what is going on a little easier.</p>

<figure class='code'><figcaption><span>Reading the Gibberish - gibberish.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="c1"># We&#39;ve seen %w() once before already so we know what that does</span>
</span><span class='line'><span class="c1"># the rest of the methods operate on that value producing the symbol</span>
</span><span class='line'><span class="c1"># value :eval</span>
</span><span class='line'><span class="n">arg1</span> <span class="o">=</span> <span class="sx">%w(ale lava)</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">join</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span><span class="o">.</span><span class="n">join</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">to_sym</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># The second argument gets its value from the C variable defined at the top of the file.</span>
</span><span class='line'><span class="c1"># C is first split by the string 0x into a new array. The first element of the array is</span>
</span><span class='line'><span class="c1"># omitted using the range [1..-1] and map is applied to the new array of values.</span>
</span><span class='line'><span class="n">arg2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/0x/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">b</span><span class="o">|</span>
</span><span class='line'>  <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">to_i</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># Each value of the array is converted from a hex value into an integer</span>
</span><span class='line'>  <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span>     <span class="c1"># Right shifted by two</span>
</span><span class='line'>  <span class="n">b</span><span class="o">.</span><span class="n">chr</span>          <span class="c1"># And the integer value is converted to an ASCII character and returned</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This newly formed array of ASCII characters is joined together!</span>
</span><span class='line'><span class="n">arg2</span> <span class="o">=</span> <span class="n">arg2</span><span class="o">.</span><span class="n">join</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Now that we have our two arguments, they&#39;re used in the Object#send method.</span>
</span><span class='line'><span class="c1"># Object#send sends a given message to an object (in our case identified by the symbol</span>
</span><span class='line'><span class="c1"># :eval stored in arg1) providing the arguments which follow.</span>
</span><span class='line'><span class="nb">send</span><span class="p">(</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we know what the obfuscated code is! It&#8217;s a series of ASCII characters, left shifted twice, converted to hexadecimal, and separated by the string &#8216;0x&#8217;. It is being used as the value to <code>send(:eval,string)</code> which means it must be more ruby code!</p>

<p>Why did I do this? I had started with simple hex conversion, but I found I needed a larger canvas on which to draw my ASCII art, so the left shifting increased the hex values enough that I had a little more text to work with!</p>

<h2>We Have to Go Deeper</h2>

<p>Now that we know how the code is interpreted, we print it by replacing the code creating the <code>:eval</code> symbol with the symbol <code>:print</code> and the application will dutifully output the vanilla code!</p>

<p>The output of which is as follows:</p>

<figure class='code'><figcaption><span>Sinatra Enters the Building - sinatra.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="s1">&#39;zlib&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;base64&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;coderay&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Wizardry</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">do_some_magic</span><span class="p">(</span> <span class="n">request</span> <span class="p">)</span>
</span><span class='line'>      <span class="n">iywRFqowCSzrNe</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>          <span class="s2">&quot;==geeZ6bD0nS1mp8AGeHt2VR+Tmyq3mD7rt5jLg7</span><span class="se">\n</span><span class="s2">u9dxALYH4m/+GLeH6FKh4IlsCvFaCqFMQvZg0jN6YjuY2g/PR8zCu2FvLkE/</span><span class="se">\n</span><span class="s2">/jX629hL4wfVvJOm6YGkvLne1Gn/xHgYFnhGzxYxzuzU14EScm+/Jv8ErvIB</span><span class="se">\n</span><span class="s2">Zcdx1ftynZWYIyxucKb9tVdqU1aR9saTVwak7lKC0jKS7bHEHzLfNbuZehgs</span><span class="se">\n</span><span class="s2">pu7/KtYaZKNbwezVdLdWK9iWRuE2CuIwDRcFklLJ9sUF5/ehQEzALF0jdpNe&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;=oGq17wPIy0sZJ/JgLjZvX7vpr/D7vtCK+C0/Nr3fOv6</span><span class="se">\n</span><span class="s2">QpIN7OCFRp3M4lxUwHyWOdTJBXHf3phtezdqJtPv00BFFJF+Z/SnLmANQeID</span><span class="se">\n</span><span class="s2">6sl8Qf5oiuQ97DvchW+aqUT2k3Nn5e/8mj5lGx4j6q/Uze77MGmDe9R7OPey</span><span class="se">\n</span><span class="s2">7/N0ZSimTZE9lpOmJzS7mgpqoRdsJLuLbNAmTnwnZikMjnuCl/pTainokOWE</span><span class="se">\n</span><span class="s2">RuxORDYibKrh8cMQ7691WoTRaTekD2FwP598I7LRXbHmIWV6jciXQMcQ0IU8</span><span class="se">\n</span><span class="s2">g6q22SaDJZUEq0LEN2FG2fWONOFFWw94DE9WVasFQsappUZYsLVKXZdpNanq</span><span class="se">\n</span><span class="s2">IYdgWUNq5EAWWBtlHmIaXflSSwdENagIKQQim+dgdsmpPwUM3zr3hxQhIo4s</span><span class="se">\n</span><span class="s2">9+frt2amxYSza4o7lIq02HLS9qkFXK4wErVWK0F26xwVm/chQEjArFEkdpNe&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;Ucu1Mbw+U0DbGjZeP+3JdnhF</span><span class="se">\n</span><span class="s2">aqjeaQeBKyBy5sKhJSzbU4z+hSyYoBpZA1sOXKC4DBvCXFQnyQCXwHkTPJyP</span><span class="se">\n</span><span class="s2">vTbgExcGmPH5ZUBFH6QG0skB6npa/e+nwuW6OWIGC+AO8ODzgt+tvMqnq0pN</span><span class="se">\n</span><span class="s2">gLIjU65cteemMlpwvEDjD7qfU6ahsnP8unG81nnevf99W66TyIN21gqgkznp</span><span class="se">\n</span><span class="s2">zowRSeTJFylFUKB4mmzFhxc7eE0dksLmOaayBv13mCCSyZQCGwDworrCYbBv</span><span class="se">\n</span><span class="s2">xbuB52nsNxxNBwaC+DajTw1TZrftBFGw3wf7TR4g1LlOyomra+YbLjVVpb7Z</span><span class="se">\n</span><span class="s2">Di7Cr5gl3mwaWy/FG74Vp5PH1rdyhoz2r1R76fsKrO06/90T71Ftcz+whgLg</span><span class="se">\n</span><span class="s2">9mt+XDxf2tSqWdRdSzMVfGU89hBmvkYYxzISMj0FFG3TX/ZxUAjwP91jNqNe&quot;</span>
</span><span class='line'>      <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">eval</span> <span class="no">Zlib</span><span class="o">::</span><span class="no">Inflate</span><span class="o">.</span><span class="n">inflate</span><span class="p">(</span><span class="no">Base64</span><span class="o">::</span><span class="n">decode64</span><span class="p">(</span><span class="n">iywRFqowCSzrNe</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">reverse</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="n">except</span><span class="p">:</span> <span class="ss">:ip_spoofing</span>
</span><span class='line'>
</span><span class='line'><span class="n">get</span> <span class="s1">&#39;/src&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;i_has_a_secret&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;=IQCg7GAG4MTJ5yCN&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;lulz&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;lllululuulull&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="no">XYZZY</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">CodeRay</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="ss">:ruby</span><span class="p">)</span><span class="o">.</span><span class="n">page</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content_type</span> <span class="ss">:txt</span>
</span><span class='line'>  <span class="no">Wizardry</span><span class="o">::</span><span class="n">do_some_magic</span><span class="p">(</span> <span class="n">request</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We now have some code which looks more like a standard Sinatra application!</p>

<p>Those of you following along at home will notice that your code looks slightly different. The contents of the <code>get '/src' do</code> block and line 15 of the source above were originally obfuscated in a similar manner to the original file. I&#8217;ve taken the liberty of revealing them to you now, since the process of doing so is identical to the previous process we used.</p>

<p>There are a few portions of this code we should make note of:</p>

<ol>
<li>The first index of the array <code>iywRFqowCSzrNe</code> is a reversed base64 encoded zlib compressed chunk of Ruby code. It is reasonable to assume that the other two array locations may be similarly encoded.</li>
<li>The /src path sets some response headers. Their purpose isn&#8217;t immediately obvious.</li>
<li>The definition of <code>XYZZY</code> in the original file is important. The value of <code>__FILE__</code> changes when it is located inside of a string being run through <code>eval</code>. Storing the value of <code>__FILE__</code> in <code>XYZZY</code> allowed this obfuscated code to keep track of the current file name.</li>
</ol>


<p>If we go ahead and print the value of the first array we find that the first array value executes the second array value, which in turn executes the third. De-obfuscating this code manually we end up with code similar to the following.</p>

<figure class='code'><figcaption><span>Array code 0  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Fetches the value of the HTTP response header i_has_a_secret and stores it to the array</span>
</span><span class='line'><span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">/src&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'><span class="n">iywRFqowCSzrNe</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="s1">&#39;i_has_a_secret&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Array code 1  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#Fetch the value of the &#39;lulz&#39; HTTP request header</span>
</span><span class='line'><span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">/src&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'><span class="n">lulz</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="s1">&#39;lulz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#Using the value of the &#39;lulz&#39; HTTP header, alter the case of the characters in the host </span>
</span><span class='line'><span class="c1">#name on which the application is running, and store the result in the second array location</span>
</span><span class='line'><span class="n">iywRFqowCSzrNe</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="sr">/^[^.]+/</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">lulz</span><span class="o">.</span><span class="n">pop</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span>
</span><span class='line'>      <span class="n">x</span><span class="o">.</span><span class="n">upcase</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">x</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span><span class="o">.</span><span class="n">join</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Array code 2  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Gets the name of the local variables defined in the scope of the method</span>
</span><span class='line'><span class="c1"># Looks for one which, when combined with the values from above represents</span>
</span><span class='line'><span class="c1"># a reversed base64 zlib compressed string, and returns that value</span>
</span><span class='line'><span class="n">l</span> <span class="o">=</span> <span class="nb">local_variables</span>
</span><span class='line'><span class="n">l</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>  <span class="n">iywRFqowCSzrNe</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>      <span class="n">l</span> <span class="o">=</span> <span class="no">Zlib</span><span class="o">::</span><span class="no">Inflate</span><span class="o">.</span><span class="n">inflate</span><span class="p">(</span><span class="no">Base64</span><span class="o">::</span><span class="n">decode64</span><span class="p">(</span><span class="n">iywRFqowCSzrNe</span><span class="o">.</span><span class="n">join</span><span class="o">.</span><span class="n">reverse</span><span class="p">))</span>
</span><span class='line'>      <span class="k">break</span>
</span><span class='line'>  <span class="k">rescue</span>
</span><span class='line'>      <span class="c1">#Yeah, catching all exceptions is horrible.. um.. chalk it up to &quot;obfuscation&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">return</span> <span class="n">l</span>
</span></code></pre></td></tr></table></div></figure>


<p>These small blocks of code, which were hidden in the array <code>iywRFqowCSzrNe</code> reveal their importance.
They also help me achieve the rest of my goals for my obfuscated code!</p>

<p>When these chunks of code are run in order as a result of a request to the root path the result is the string &#8220;Happy Birthday OpenStack&#8221; being output as a text/plain document.</p>

<h2>Reviewing the Objectives</h2>

<p>I was very happy with the ways in which I met my original goals.</p>

<ol>
<li>The code looked pretty thanks to ASCII images in original obfuscated code.</li>
<li>The code itself was obfuscated in two separate ways

<ul>
<li>The original code is obfuscated through hex encoded shifted integer character values</li>
<li>The internal code is encoded in reversed base64 zlib compressed strings</li>
</ul>
</li>
<li>The actual string &#8220;Happy Birthday OpenStack&#8221; isn&#8217;t present in fully de-obfuscated code

<ul>
<li>The string itself is yet another reversed base64 encoded zlib compressed string split into 3 parts</li>
<li>The first part is the host name of the machine running the code</li>
<li>The second part is the value of the <code>i_has_a_secret</code> HTTP response header from the /src URI</li>
<li>The final part is the variable name of an array in the source code itself!</li>
</ul>
</li>
</ol>


<p>I was quite happy that I managed to come up with three distinct methods in which to store the text &#8220;Happy Birthday OpenStack&#8221;. I hope you have enjoyed this de-obfuscation walk-through and post-mortem.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Joe "coderjoe" Bauser</span></span>

      








  


<time datetime="2012-07-26T19:01:00-04:00" pubdate data-updated="true">Jul 26<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/categories/coding/'>coding</a>, <a class='category' href='/categories/contests/'>contests</a>, <a class='category' href='/categories/obfuscation/'>obfuscation</a>, <a class='category' href='/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://coderjoe.net/archive/2012/07/26/openstack-contest-post-mortem/" data-via="coderjoe" data-counturl="http://coderjoe.net/archive/2012/07/26/openstack-contest-post-mortem/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/archive/2011/04/03/official-rstarcraft-info-firefox-extension/" title="Previous Post: Official Rstarcraft.info Firefox Extension">&laquo; Official Rstarcraft.info Firefox Extension</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/archive/2012/07/26/openstack-contest-post-mortem/">How I Won the OpenStack Birthday Contest</a>
      </li>
    
      <li class="post">
        <a href="/archive/2011/04/03/official-rstarcraft-info-firefox-extension/">Official Rstarcraft.info Firefox Extension</a>
      </li>
    
      <li class="post">
        <a href="/archive/2011/03/23/rstarcraft_info_beta_launch/">rstarcraft.info beta launch</a>
      </li>
    
      <li class="post">
        <a href="/archive/2009/02/14/earth-hour/">Earth Hour</a>
      </li>
    
      <li class="post">
        <a href="/archive/2008/12/01/a-little-turkey-day-coding/">A little turkey day coding!</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/coderjoe">@coderjoe</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'coderjoe',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("coderjoe", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/coderjoe" class="twitter-follow-button" data-show-count="false">Follow @coderjoe</a>
  
</section>


<section>
  <h1>Coderwall</h1>
  <ul id="cw_badges">
    <li class="loading">Status updating...</li>
  </ul>

  <script type="text/javascript">
    var coderwall = (function(){
      function render(options, badges){
        var fragment = '',
            t = $(options.target)[0],
            height = 65,
            width = 65,
            index;

        for (index in badges) {
          fragment += '<a class="cw_badge"title="' + badges[index].description + '" href="http://coderwall.com/' + options.user + '">';
          fragment +=   '<img alt="' + badges[index].description + '" height="' + width + '" width="' + height + '" src="' + badges[index].badge + '"/>';
          fragment += '</a>';
        }

        t.innerHTML = fragment;
      }
      return {
        showBadges: function(options){
          $.ajax({
              url: 'http://coderwall.com/' + options.user + '.json?callback=?'
            , type: 'jsonp'
            , error: function (err) { $(options.target + ' li.loading').addClass('error').text("Error loading feed"); }
            , success: function(res) {
                render(options, res.data.badges);
            }
          });
        }
      };
    })();

    $.domReady(function(){
      if (!window.jXHR){
        var jxhr = document.createElement('script');
        jxhr.type = 'text/javascript';
        jxhr.src = '/javascripts/libs/jXHR.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(jxhr, s);
      }
      if (!window.$){
        var b = document.createElement('script');
        b.type = 'text/javascript';
        b.src = '/javascripts/ender.js';
        var sc = document.getElementsByTagName('script')[0];
        sc.parentNode.insertBefore(jxhr, s);
      }
      coderwall.showBadges({
        user: 'coderjoe',
        target: '#cw_badges'
      });
    });
  </script>
  <style type="text/css">
    .cw_badge img {
      padding: 5px;
      border: 0 none !important;
      -moz-box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -o-box-shadow: none !important;
      box-shadow: none !important;
    }
  </style>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/110889592930310051971?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Joe "coderjoe" Bauser -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'coderjoenet';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://coderjoe.net/archive/2012/07/26/openstack-contest-post-mortem/';
        var disqus_url = 'http://coderjoe.net/archive/2012/07/26/openstack-contest-post-mortem/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
